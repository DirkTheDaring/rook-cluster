- name: Deploy with helm
  when: rook_ceph_server and rook_deployment == "helm"
  block:
    - name: Add chart repo
      kubernetes.core.helm_repository:
        name:     "{{ rook_helm_repo_name }}"
        repo_url: "{{ rook_helm_repo_url }}"

    - name: Create values.yaml content if verbosity > 2
      ansible.builtin.template:
        src:  "cluster-values.yaml.jinja2"
        dest: "/tmp/rook-cluster-values.yaml"
        mode: '0664'
      when: ansible_verbosity > 2

    - name: Render values.yaml
      ansible.builtin.set_fact:
        rook_cluster_values_yaml: "{{ lookup('template', 'cluster-values.yaml.jinja2') }}"

    - name: Deploy helm chart
      kubernetes.core.helm:
        chart_ref:         "{{ rook_helm_repo_name }}/{{ rook_helm_cluster_chart_name }}"
        chart_version:     "{{ helm_chart_version }}"
        release_namespace: "{{ rook_namespace }}"
        release_name:      "{{ rook_helm_cluster_chart_release_name }}"
        create_namespace:  true
        release_values:    "{{ rook_cluster_values_yaml | from_yaml }}"
        update_repo_cache: true
