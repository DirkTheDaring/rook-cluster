- name: deploy with helm
  block:
  - name: Add chart repo
    kubernetes.core.helm_repository:
      name:     "{{ rook_helm_repo_name }}"
      repo_url: "{{ rook_helm_repo_url }}"

  - name: render values.yaml
    set_fact:
      rook_cluster_values_yaml: "{{ lookup('template', 'cluster-values.yaml.jinja2') }}"

#  - name: copy values.yaml for debugging
#    copy:
#      content: "{{ rook_cluster_values_yaml }}"
#      dest: "/tmp/rook-cluster-values.yaml"
#    when: false

  - name: Deploy helm chart
    kubernetes.core.helm:
      chart_ref:         "{{ rook_chart_cluster_name }}"
      chart_version:     "{{ helm_chart_version }}"
      release_namespace: "{{ rook_namespace }}"
      release_name:      "{{ rook_chart_cluster_release_name }}"
      create_namespace:  true
      values:            "{{ rook_cluster_values_yaml | from_yaml }}"
      update_repo_cache: yes

  when: rook_ceph_server and rook_deployment == "helm"
