- block:
  # kubectl -n rook-ceph get job export-vars-for-external --no-headers --ignore-not-found -o custom-columns=NAME:metadata.name
  - name: Check if job exists
    ansible.builtin.command:
      argv:
      -  bash
      - -c
      - "kubectl -n {{ rook_namespace }} get job export-vars-for-external --no-headers --ignore-not-found -o custom-columns=NAME:metadata.name"
    register: rook_job

  - name: report rook_job result
    debug:
      msg: "{{ rook_job.stdout }}"
      verbosity: 1

  - name: Create a directory if it does not exist
    ansible.builtin.file:
      path: "{{ rook_credentials_dir }}"
      state: directory
      mode: '0700'
  when: rook_ceph_server

- block:
  - debug:
      msg: "works <= 1.8"
  - name: Create job and wait for completion - can take very long
    kubernetes.core.k8s:
      template: export-job.yaml.jinja2
      wait: yes
      wait_condition:
        type:   Complete
        status: True
      wait_timeout: 7200 # seconds
    when: rook_job.stdout == ""
  - name: read variable section of export
    ansible.builtin.command:
      argv:
      -  bash
      - -c
      - "kubectl -n {{ rook_namespace }} get  pod -l job-name=export-vars-for-external -o custom-columns=NAME:metadata.name --no-headers | xargs kubectl -n {{ rook_namespace }} logs | awk '{ if ( f==1) {print }} /^### AUTOGEN/ { f=1 }'"
    register: rook_export_result
  - name: Create config.json in rook_credentials_dir
    ansible.builtin.copy:
      content: "{{ rook_export_result.stdout | from_json | to_nice_json }}\n"
      dest:    "{{ rook_credentials_dir }}/config.json"

  when:
  - rook_job.stdout == ""
  - rook_ceph_server
  when:
  - rook_ceph_server
  - rook_version_major|int == 1
  - rook_version_minor|int <= 8

- block:
  - debug:
      msg: "works >= 1.9 "
  - name: Create job and wait for completion - can take very long
    kubernetes.core.k8s:
      template: export-job-1.9.yaml.jinja2
      wait: yes
      wait_condition:
        type:   Complete
        status: True
      wait_timeout: 7200 # seconds
    when: rook_job.stdout == ""
  - name: read variable section of export
    ansible.builtin.command:
      argv:
      -  bash
      - -c
      - "kubectl -n {{ rook_namespace }} get  pod -l job-name=export-vars-for-external -o custom-columns=NAME:metadata.name --no-headers | xargs kubectl -n {{ rook_namespace }} logs"
    register: rook_export_result
  - name: Create config.json in rook_credentials_dir
    ansible.builtin.copy:
      content: "{{ rook_export_result.stdout | from_json | to_nice_json }}\n"
      dest:    "{{ rook_credentials_dir }}/config-1.9.json"
  when:
  - rook_ceph_server
  - rook_version_major|int == 1
  - rook_version_minor|int >= 9
