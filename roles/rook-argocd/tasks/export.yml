- block:
  - name: Check if job exists
    ansible.builtin.command:
      argv:
      -  bash
      - -c
      - "kubectl -n {{ rook_namespace }} get job export-vars-for-external --no-headers -o custom-columns=NAME:metadata.name || exit 0"
    register: rook_job

  - name: report rook_job result
    debug:
      msg: "{{ rook_job }}"
 
  - name: Create job and wait for completion - can take very long
    kubernetes.core.k8s:
      template: export-job.yaml.jinja2
      wait: yes
      wait_condition:
        type:   Complete
        status: True
      wait_timeout: 7200 # seconds
    when: rook_job.stdout == ""

  - name: read variable section of export
    ansible.builtin.command:
      argv:
      -  bash
      - -c
      - "kubectl -n {{ rook_namespace }} get  pod -l job-name=export-vars-for-external -o custom-columns=NAME:metadata.name --no-headers | xargs kubectl -n {{ rook_namespace }} logs | awk '{ if ( f==1) {print }} /^### AUTOGEN/ { f=1 }'"
    register: rook_export_result


  - name: Create a directory if it does not exist
    ansible.builtin.file:
      path: "{{ rook_credentials_dir }}"
      state: directory
      mode: '0700'

  - ansible.builtin.copy:
      content: "{{ rook_export_result.stdout | from_json | to_nice_json }}\n"
      dest:    "{{ rook_credentials_dir }}/config.json"
    when: rook_job.stdout == ""

  when: rook_ceph_server
