- name: Add chart repo
  kubernetes.core.helm_repository:
    name:     "{{ argocd_chart_name }}"
    repo_url: "{{ argocd_chart_url }}"


- set_fact:
    argocd_values_yaml: "{{ lookup('template', 'values.yaml.jinja2') }}"
  when: argocd_ldap_server == ""

- set_fact:
    argocd_values_yaml: "{{ lookup('template', 'ldap-values.yaml.jinja2') }}"
  when: argocd_ldap_server != ""

- copy:
    content: "{{ argocd_values_yaml }}"
    dest: "/tmp/argocd-values.yaml"

#- fail:
#   msg: intended

- name: Deploy helm for argocd
  kubernetes.core.helm:
    chart_ref:         argocd/argo-cd
    chart_version:     "{{ argocd_chart_version }}"
    release_namespace: "{{ argocd_namespace }}"
    release_name:      "{{ argocd_chart_release_name }}"
    create_namespace:  true
    values:            "{{ argocd_values_yaml | from_yaml }}"
    update_repo_cache: yes
