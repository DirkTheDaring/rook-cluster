- name: deploy with helm
  block:
  - name: Add chart repo
    kubernetes.core.helm_repository:
      name:     "{{ storage1_helm_repo_name }}"
      repo_url: "{{ storage1_helm_repo_url }}"

  - name: Create values.yaml content if verbosity > 2
    ansible.builtin.template:
      src:  "values.yaml.jinja2"
      dest: "/tmp/rook-values.yaml"
      mode: '0664'
    when: ansible_verbosity > 2

  - name: render values.yaml
    set_fact:
      storage1_values_yaml: "{{ lookup('template', 'values.yaml.jinja2') }}"


  - name: Deploy helm chart
    kubernetes.core.helm:
      chart_ref:         "{{ storage1_helm_repo_name }}/{{ storage1_helm_chart_name }}"
      chart_version:     "{{ helm_chart_version }}" # yes no prefix storage1_ !
      release_namespace: "{{ storage1_namespace }}"
      release_name:      "{{ storage1_chart_release_name | default('rook-ceph') }}"
      create_namespace:  true
#      values:            "{{ storage1_values_yaml | from_yaml }}"
      update_repo_cache: yes

  when: storage1_deployment == "helm"
