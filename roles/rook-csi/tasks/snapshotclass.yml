  
- name: get major and minor version to determine the release tag in git 
  set_fact:
    rook_release_tag: "{{ rook_release[1:].split('.')[0:2]|join('.') }}"
  when: not (rook_release_tag is defined and rook_release_tag != "")

- name: build git raw url with release tag 
  set_fact:
    rook_release_url: "https://raw.githubusercontent.com/rook/rook/{{ 'release-' + rook_csi_release_tag if rook_csi_release_tag != 'master' else 'master' }}"
    snapshotclasses:
    # pre 1.8.0
    #- cluster/examples/kubernetes/ceph/csi/cephfs/snapshotclass.yaml
    #- cluster/examples/kubernetes/ceph/csi/rbd/snapshotclass.yaml
    # From 1.8.0
    - deploy/examples/csi/cephfs/snapshotclass.yaml
    - deploy/examples/csi/rbd/snapshotclass.yaml

- name: Create directory for rook_csi_tmp_dir2
  ansible.builtin.file:
    path: "{{ rook_csi_tmp_dir2 }}"
    state: directory
    mode: '0755'
  when: rook_csi_tmp_dir2 is defined and rook_csi_tmp_dir2 != ""

- block: 
  - name: Create temporary directory
    ansible.builtin.tempfile:
      state:  directory
    register: rook_csi_tmp_dir2_created
  - set_fact:
      rook_csi_tmp_dir2: "{{ rook_csi_tmp_dir2_created.path }}"
  when: not (rook_csi_tmp_dir2 is defined and rook_csi_tmp_dir2 != "")

- debug:
    msg: "rook_csi_tmp_dir2 = {{ rook_csi_tmp_dir2 }}"

- name: Recreate directory structure
  ansible.builtin.file:
    path: "{{ rook_csi_tmp_dir2 }}/{{ item | dirname }}"
    state: directory
    mode: '0755'
  loop: "{{ snapshotclasses }}"

- name: download
  get_url:
    url:  "{{ rook_release_url   }}/{{ item            }}"
    dest: "{{ rook_csi_tmp_dir2  }}/{{ item }}"
    mode: '0440'
  ignore_errors: yes
  loop: "{{ snapshotclasses }}"

- name: apply VolumeSnapshotClass(es)
  kubernetes.core.k8s:
    state: present
    src: "{{ rook_csi_tmp_dir2 }}/{{ item }}"
  loop: "{{ snapshotclasses }}"

- name: Remove temporary directory
  ansible.builtin.file:
    path: "{{ rook_csi_tmp_dir2 }}"
    state: absent
  when: rook_csi_tmp_dir2_created.path is defined

