#  curl "https://api.github.com/repos/argoproj/argo-cd/releases/latest"

# #!/bin/sh
# curl -s https://metallb.github.io/metallb/index.yaml |\
# python3 -c 'import sys, yaml, json; y=yaml.safe_load(sys.stdin.read()); print(json.dumps(y))'|\
# jq -r  '.entries.metallb[].version'   
#
# ansible uses JMESPath (https://jmespath.org/)

- name: determine latest version of helm chart
  block:
  - uri:
      url:            https://metallb.github.io/metallb/index.yaml
      return_content: true
    register:         metallb_chart_versions

  - set_fact:
      jmespath: 'entries.metallb[].version'
      #jmespath: "entries.metallb[?starts_with(version,'0.10')].version"

  - set_fact:
      metallb_chart_versions: "{{ metallb_chart_versions.content | from_yaml | json_query(jmespath) }}"
  - set_fact:
      metallb_chart_release_latest: "{{ metallb_chart_versions[0] }}"
  - set_fact:
      metallb_chart_version : "{{ metallb_chart_release_latest }}"

  when: metallb_chart_version == "latest"

# curl -s https://api.github.com/repos/metallb/metallb/releases |jq -r  '.[].tag_name
#
# [].{tag_name:tag_name}

- name: determine latest version of app
  block:
  - uri:
      url:            https://api.github.com/repos/metallb/metallb/releases
      body_format:    json
      return_content: no
    register: metallb_app_releases
 
  - set_fact:
      #jmespath: "[?starts_with(tag_name, 'v')].tag_name"     # all elements
      #jmespath: "[?starts_with(tag_name, 'v')]|[0].tag_name" # only first element
      #jmespath: ".tagname|[0]"
      jmespath: "[?starts_with(tag_name, 'v')]|[0].tag_name"  # only first element

  - set_fact:
      metallb_app_version_latest: "{{ metallb_app_releases.json | to_json | from_json | json_query(jmespath) }}"
  - set_fact:
      # set metallb_version to latest if it is not set or variable is empty (== "")
      metallb_app_version: "{{ metallb_app_version_latest }}"

  when: metallb_app_version is defined and metallb_app_version == "latest"

- debug:
    msg: "metallb_chart_version: {{ metallb_chart_version }}"

- debug:
    msg: "metallb_app_version: {{ metallb_app_version | default('< not enforced >') }}"

