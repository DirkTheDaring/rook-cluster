- name: determine latest version of helm chart
  block:
  - uri:
      url:            "{{ nfs_subdir_external_provisioner_chart_url }}/index.yaml"
      return_content: yes
    register: nfs_subdir_external_provisioner_chart_index

  - name: extract chart_versions
    set_fact:
      nfs_subdir_external_provisioner_chart_versions: "{{ nfs_subdir_external_provisioner_chart_index.content | from_yaml | json_query(nfs_subdir_external_provisioner_chart_jmespath) }}"

  - name: show available chart_versions
    debug:
      msg:       "nfs_subdir_external_provisioner_chart_versions: {{ nfs_subdir_external_provisioner_chart_versions }}"
      verbosity: 2

  - name: filter chart_versions if a regex was specified
    set_fact:
      nfs_subdir_external_provisioner_chart_versions: "{{ nfs_subdir_external_provisioner_chart_versions | select('match', nfs_subdir_external_provisioner_chart_version[1:] ) | list }}"
    when: nfs_subdir_external_provisioner_chart_version.startswith("~")

  - name: fail when there are no chart_versions to pick available
    fail:
     msg: "no release found: nfs_subdir_external_provisioner_chart_version={{ nfs_subdir_external_provisioner_chart_version }}"
    when: nfs_subdir_external_provisioner_chart_versions|length == 0

  - name: pick first item as release
    set_fact:
      nfs_subdir_external_provisioner_chart_version: "{{ nfs_subdir_external_provisioner_chart_versions[0] }}"

  when: nfs_subdir_external_provisioner_chart_version == "" or nfs_subdir_external_provisioner_chart_version.startswith("~")

- debug:
    msg:       "nfs_subdir_external_provisioner_chart_version: {{ nfs_subdir_external_provisioner_chart_version | default('< not enforced >') }}"
    verbosity: 2


