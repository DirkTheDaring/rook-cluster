- block:
  # kubectl -n harbor get secret harbor-core -o custom-columns=password:data.HARBOR_ADMIN_PASSWORD --no-headers
  - name: get current password and store it
    ansible.builtin.command:
      argv:
      - kubectl
      - --namespace
      - "{{ harbor_namespace }}"
      - get
      - secret
      - harbor-core
      - -o
      - custom-columns=password:data.HARBOR_ADMIN_PASSWORD
      - --no-headers
    register: harbor_credential_result

  - name: extract password
    set_fact:
      harbor_password: "{{ harbor_credential_result.stdout | b64decode }}"
      harbor_username: "admin"
      harbor_url:      "https://{{ harbor_core_fqdn }}"

  - name: Create a directory if it does not exist
    ansible.builtin.file:
      path: "{{ harbor_credentials_dir }}"
      state: directory
      mode: '0700'

  - name: Create web.json
    template:
      src: "web.json.jinja2"
      dest: "{{ harbor_credentials_dir }}/web.json"

  when: true
