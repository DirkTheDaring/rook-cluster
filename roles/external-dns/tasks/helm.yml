- name: Add chart repo
  kubernetes.core.helm_repository:
    name:     "{{ external_dns_helm_repo_name }}"
    repo_url: "{{ external_dns_helm_repo_url }}"

- set_fact:
    external_dns_values_yaml: "{{ lookup('template', 'values.yaml.jinja2') }}"
  when: external_dns_ldap_server == ""

- set_fact:
    external_dns_values_yaml: "{{ lookup('template', 'ldap-values.yaml.jinja2') }}"
  when: external_dns_ldap_server != ""

- copy:
    content: "{{ external_dns_values_yaml }}"
    dest: "/tmp/argocd-values.yaml"

#- fail:
#   msg: intended

- name: Deploy helm for argocd
  kubernetes.core.helm:
    chart_ref:         "{{ external_dns_helm_repo_name }}/{{ external_dns_helm_chart_name }}"
    chart_version:     "{{ helm_chart_version }}"
    release_namespace: "{{ external_dns_namespace }}"
    release_name:      "{{ external_dns_chart_release_name | default('argocd') }}"
    create_namespace:  true
    values:            "{{ external_dns_values_yaml | from_yaml }}"
    update_repo_cache: yes

