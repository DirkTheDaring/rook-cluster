#- name: Create temporary file
#  ansible.builtin.tempfile:
#    state: file
#    suffix: yaml
#  register: tempfile

#- set_fact:
#    tempfile_path: "{{ tempfile.path if ansible_verbosity < 3 else '/tmp/argo-workflows-values.yaml' }}"

- name: Create values.yaml content if verbosity > 2
  ansible.builtin.template:
    src:  "values.yaml.jinja2"
    dest: "/tmp/argo-workflows-values.yaml"
    mode: '0664'
  when: ansible_verbosity > 2

- name: Load yaml and prune none values
  set_fact:
    argo_workflows_values: "{{ lookup('template', 'values.yaml.jinja2') | from_yaml | prune_none_value }}"

#- name: Prepare List which needs to be tagged with forceString
#  set_fact:
#    force_string_list: 
#    - 'ingress.annotations.traefik\.ingress\.kubernetes\.io\/router\.tls'
#    - 'initContainers[0].command[2]'

- name: Transform to application params
  set_fact:
    argo_workflows_application_params: "{{ argo_workflows_values | chart_values_to_argo_parameters(argo_workflows_force_string_dict) }}"

- name: Write result to /tmp/argo-workflows-application
  ansible.builtin.copy:
    content: "{{ argo_workflows_application_params }}"
    dest: /tmp/argo-workflows-application-params.yml
  when: ansible_verbosity > 2

- name: Create application.yaml content if verbosity > 2
  ansible.builtin.template:
    src:  "application.yaml.jinja2"
    dest: "/tmp/argo-workflows-application.yaml"
    mode: '0664'
  when: ansible_verbosity > 2

- name: create application
  kubernetes.core.k8s:
    template: application.yaml.jinja2
