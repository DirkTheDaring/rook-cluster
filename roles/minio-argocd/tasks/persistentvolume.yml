- ansible.builtin.template:
    src:  "persistentvolume.yaml.jinja2"
    dest: "/tmp/persistentvolume.yaml"
  when: false

- block:
  - name: get status.phase of persistent.volume either "Released" or "" if it fails
    ansible.builtin.command: 
      argv:
      - bash 
      - -c
      - "kubectl get pv minio-pv -o custom-columns=status:status.phase --no-headers 2>/dev/null || echo"
    register: pvstatus
  
  - name: make the released persistent volume available again 
    ansible.builtin.command: 
      argv:
      - bash 
      - -c
      - "kubectl patch pv minio-pv --type=json -p='[{\"op\": \"remove\", \"path\": \"/spec/claimRef\"}]' && kubectl patch pv minio-pv -p='{\"spec\": {\"claimRef\": {\"name\": \"{{ minio_name }}\", \"namespace\": \"{{ minio_namespace }}\"}}}'"
    when: pvstatus.stdout == "Released"

  when: minio_nfs_enabled

- name: create persistent volume for nfs
  kubernetes.core.k8s:
    template: persistentvolume.yaml.jinja2
  when: minio_nfs_enabled and pvstatus.stdout != "Released"

