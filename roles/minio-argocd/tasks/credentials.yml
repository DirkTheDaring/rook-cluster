  # kubectl -n minio get secret minio -o custom-columns=access-key:data.access-key --no-headers
- name: get access-key
  ansible.builtin.command: 
    argv:
    - kubectl
    - --namespace
    - "{{ minio_namespace }}"
    - get
    - secret
    - minio
    - -o
    - custom-columns=access-key:data.access-key
    - --no-headers
  register: minio_access_key_result

  # kubectl -n minio get secret minio -o custom-columns=secret-key:data.secret-key --no-headers
- name: get secret-key
  ansible.builtin.command: 
    argv:
    - kubectl
    - --namespace
    - "{{ minio_namespace }}"
    - get
    - secret
    - minio
    - -o
    - custom-columns=secret-key:data.secret-key
    - --no-headers
  register: minio_secret_key_result

- name: extract password 
  set_fact:
     minio_username: "{{ minio_access_key_result.stdout | b64decode }}"
     minio_password: "{{ minio_secret_key_result.stdout | b64decode }}"
     minio_url:      "https://{{ minio_gui_fqdn }}"

- name: Create a directory if it does not exist
  ansible.builtin.file:
    path: "{{ minio_credentials_dir }}"
    state: directory
    mode: '0700'

- template:
    src: "web.json.jinja2"
    dest: "{{ minio_credentials_dir }}/web.json"

# useful for velero later on
- template:
    src:  "config.json.jinja2"
    dest: "{{ minio_credentials_dir }}/config.json"


- name: Create a directory if it does not exist
  ansible.builtin.file:
    path: "{{ minio_credentials_dir }}/buckets"
    state: directory
    mode: '0700'

# useful for velero later on
- template:
    src:  "bucket.json.jinja2"
    dest: "{{ minio_credentials_dir }}/buckets/{{ item }}.json"
  loop: "{{ minio_bucket_names }}"
