# tasks/wait-for-pod-by-label.yml

  # kubectl -n metallb-system get pods -l app.kubernetes.io/component=controller --no-headers -o name
- name: Wait until pod with label app.kubernetes.io/component=controller appears
  ansible.builtin.command:
    argv:
      - bash
      - -c
      - >
        while [ -z "$(kubectl -n {{ metallb_namespace }} get pods -l app.kubernetes.io/component=controller \
                    --output=jsonpath='{.items[*].metadata.name}')" ]; do
          echo label app.kubernetes.io/component=controller not found
          sleep 10
        done

  # kubectl -n metallb-system get pods -l app.kubernetes.io/component=controller --no-headers "-ocustom-columns=data:status.conditions[?(@.type=='Ready')].type"
- name: Wait until pod with label app.kubernetes.io/component=controller becomes ready
  ansible.builtin.command:
    argv:
      - bash
      - -c
      - 'while true; do

        RESULT=$(kubectl -n {{ metallb_namespace }} get pods -l app.kubernetes.io/component=controller
        --no-headers "-ocustom-columns=data:status.conditions[?(@.type==''Ready'')].type")

        [ "$RESULT" = "Ready" ] && break

        sleep 3

        done'
